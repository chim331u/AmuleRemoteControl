@page "/setting"
@using System.Text.Json
@using AmuleRemoteControl.Components.Data.Setting

@inject ILogger<Setting> logger

<RadzenTabs RenderMode="TabRenderMode.Client" TabPosition="TabPosition.Top">
    <Tabs>
        <RadzenTabsItem Text="Network Setting">
            @if (settingList != null)
            {
                <RadzenLabel>aMule remote Url: @_utilityController.ApiUrl</RadzenLabel>
                <hr />
                <RadzenTabs RenderMode="TabRenderMode.Client" TabPosition="TabPosition.Top">
                    <Tabs>
                        @foreach (var item in settingList)
                        {
                            <RadzenTabsItem Text=@item.Name>
                                <RadzenTemplateForm TItem="@NetworkSetting" Data=@item InvalidSubmit=@OnInvalidSubmit Submit="@SaveSetting">
                                    <RadzenStack>
                                        <RadzenFormField Text="Name" Variant="Variant.Text">
                                            <ChildContent>
                                                <RadzenTextBox Name="name" @bind-Value="@item.Name" />
                                            </ChildContent>
                                            <Helper>
                                                <RadzenRequiredValidator Component="name" Text="Name is required." />
                                            </Helper>
                                        </RadzenFormField>
                                        <RadzenFormField Text="Address" Variant="Variant.Text">
                                            <ChildContent>
                                                <RadzenTextBox Name="address" @bind-Value="@item.Address" Placeholder="mule address" />
                                            </ChildContent>
                                            <Helper>
                                                <RadzenRequiredValidator Component="address" Text="Address is required." />
                                            </Helper>
                                        </RadzenFormField>
                                        <RadzenFormField Text="Port" Variant="Variant.Text">
                                            <ChildContent>
                                                <RadzenTextBox Name="port" @bind-Value="@item.Port" />
                                            </ChildContent>
                                            <Helper>
                                                <RadzenRequiredValidator Component="port" Text="Port is required." />
                                            </Helper>
                                        </RadzenFormField>
                                        <RadzenStack>
                                            <RadzenText Text="Is Active"></RadzenText>
                                            <RadzenSwitch @bind-Value=@item.IsActive Change="@(args=>IsActiveChange(item))"></RadzenSwitch>
                                        </RadzenStack>
                                        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                                            <RadzenButton ButtonStyle="ButtonStyle.Dark" Icon="delete" Text="Delete" Click="@(args=>DeleteSetting(item))"></RadzenButton>
                                            <RadzenButton ButtonType="ButtonType.Submit" ButtonStyle="ButtonStyle.Success" Icon="save" Text="Save"></RadzenButton>
                                        </RadzenStack>
                                    </RadzenStack>
                                </RadzenTemplateForm>
                            </RadzenTabsItem>
                        }
                        <RadzenTabsItem Icon="add" @onclick="AddNewSetting">
                            <RadzenTemplateForm TItem="@NetworkSetting" Data=@newNetworkSetting InvalidSubmit=@OnInvalidSubmit Submit="@AddSetting">
                                <RadzenStack>
                                    <RadzenFormField Text="Name" Variant="Variant.Text">
                                        <ChildContent>
                                            <RadzenTextBox Name="name" @bind-Value="@newNetworkSetting.Name" Placeholder="Connection name" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenRequiredValidator Component="name" Text="Name is required." />
                                        </Helper>
                                    </RadzenFormField>
                                    <RadzenFormField Text="Address" Variant="Variant.Text">
                                        <ChildContent>
                                            <RadzenTextBox Name="address" @bind-Value="@newNetworkSetting.Address" Placeholder="mule Address" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenRequiredValidator Component="address" Text="Address is required." />
                                        </Helper>
                                    </RadzenFormField>
                                    <RadzenFormField Text="Port" Variant="Variant.Text">
                                        <ChildContent>
                                            <RadzenTextBox Name="port" @bind-Value="@newNetworkSetting.Port" Placeholder="mule remote port" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenRequiredValidator Component="port" Text="Port is required." />
                                        </Helper>
                                    </RadzenFormField>
                                    <RadzenStack>
                                        <RadzenText Text="Is Active"></RadzenText>
                                        <RadzenSwitch @bind-Value=@newNetworkSetting.IsActive Change="@(args=>IsActiveChange(newNetworkSetting))"></RadzenSwitch>
                                    </RadzenStack>
                                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                                        <RadzenButton ButtonStyle="ButtonStyle.Dark" Icon="backspace" Text="Cancel" Click="@AddNewSetting"></RadzenButton>
                                        <RadzenButton ButtonType="ButtonType.Submit" ButtonStyle="ButtonStyle.Success" Icon="save" Text="Save"></RadzenButton>
                                    </RadzenStack>
                                </RadzenStack>
                            </RadzenTemplateForm>
                        </RadzenTabsItem>
                    </Tabs>
                </RadzenTabs>
            }
        </RadzenTabsItem>
        <RadzenTabsItem Text="Application">
            <RadzenStack Gap="1rem" class="rz-p-4">
                <RadzenFieldset Text="Language & Region">
                    <RadzenStack Gap="1rem">
                        <RadzenFormField Text="Application Language" Variant="Variant.Outlined">
                            <RadzenDropDown @bind-Value="@selectedCulture"
                                            Data="@availableCultures"
                                            TextProperty="DisplayName"
                                            ValueProperty="Name"
                                            Change="@OnCultureChanged"
                                            Style="width: 100%;" />
                        </RadzenFormField>
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-info-light">
                            Changes the number formatting, date formatting, and currency display throughout the application.
                        </RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2">
                            <strong>Current Culture:</strong> @_cultureProvider?.GetCulture().DisplayName
                        </RadzenText>
                    </RadzenStack>
                </RadzenFieldset>
            </RadzenStack>
        </RadzenTabsItem>
    </Tabs>
</RadzenTabs>


@code {
    [Inject]
    public IUtilityServices? _utilityController { get; set; }
    [Inject]
    public ILogger<string>? _logger { get; set; }
    [Inject]
    public ICultureProvider? _cultureProvider { get; set; }

    IList<NetworkSetting>? settingList;

    NetworkSetting? newNetworkSetting = new NetworkSetting();

    bool addNew = false;

    // Culture selection fields
    string? selectedCulture;
    List<CultureInfo> availableCultures = new();

    protected override void OnInitialized()
    {
        settingList = _utilityController.ReadNetworkSettingJson().OrderByDescending(x => x.IsActive).ToList();

        // Initialize culture selection
        if (_cultureProvider != null)
        {
            var supportedCultures = _cultureProvider.GetSupportedCultures();
            availableCultures = supportedCultures
                .Select(c => new CultureInfo { Name = c, DisplayName = _cultureProvider.GetCultureDisplayName(c) })
                .ToList();

            selectedCulture = _cultureProvider.GetCulture().Name;
        }
    }

    private void OnCultureChanged(object value)
    {
        if (value is string cultureName && _cultureProvider != null)
        {
            try
            {
                _cultureProvider.SetCulture(cultureName);

                NotificationService?.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Language Changed",
                    Detail = $"Application language changed to {_cultureProvider.GetCulture().DisplayName}",
                    Duration = 4000
                });

                StateHasChanged();
            }
            catch (Exception ex)
            {
                _logger?.LogError(ex, "Failed to change culture");

                NotificationService?.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Language Change Failed",
                    Detail = $"Failed to change language: {ex.Message}",
                    Duration = 4000
                });
            }
        }
    }

    // Helper class for culture dropdown
    public class CultureInfo
    {
        public string Name { get; set; } = string.Empty;
        public string DisplayName { get; set; } = string.Empty;
    }

    private void SaveSetting(NetworkSetting setting)
    {
        var isSaved = _utilityController.WriteNetworkSettingJson(settingList);
        if (isSaved)
        {
            NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Setting saved",
                    Detail = $"Setting saved",
                    Duration = 4000

                });
            NavManager.NavigateTo("/login");
        }
        else
        {
            NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Setting save failed",
                    Detail = $"File not saved - Please check the log",
                    Duration = 4000

                });
        }
        StateHasChanged();
    }

    private void AddSetting(NetworkSetting setting)
    {
        settingList.Add(setting);

        var isSaved = _utilityController.WriteNetworkSettingJson(settingList);
        if (isSaved)
        {
            NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Setting Added",
                    Detail = $"Setting saved",
                    Duration = 4000

                });
        }
        else
        {
            NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Setting save failed",
                    Detail = $"Setting not saved - Please check the log",
                    Duration = 4000

                });
        }
        newNetworkSetting = new NetworkSetting();
        StateHasChanged();
    }

    private void DeleteSetting(NetworkSetting setting)
    {
        settingList.Remove(setting);

        var isSaved = _utilityController.WriteNetworkSettingJson(settingList);

        if (isSaved)
        {
            NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Setting deleted",
                    Detail = $"Setting deleted",
                    Duration = 4000

                });
        }
        else
        {
            NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Setting delete failed",
                    Detail = $"File not saved - Please check the log",
                    Duration = 4000

                });
        }
        StateHasChanged();
    }

    private void AddNewSetting()
    {
        newNetworkSetting = new NetworkSetting();
        StateHasChanged();
    }

    private void OnInvalidSubmit(FormInvalidSubmitEventArgs args)
    {
        NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = "Incomplete form",
                Detail = $"Compile required fields",
                Duration = 4000

            });
    }

    private void IsActiveChange(NetworkSetting networkSetting)
    {
        if (networkSetting.IsActive)
        {
            networkSetting.IsActive = false;
            //set all other not active
            var activeSetting = settingList.Where(x => x.IsActive).FirstOrDefault();

            activeSetting.IsActive = false;
            networkSetting.IsActive = true;
        }
    }


}