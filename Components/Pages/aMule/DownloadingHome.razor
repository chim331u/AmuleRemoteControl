@page "/downloading"
@page "/home"

@using AmuleRemoteControl.Components.Data.AmuleModel
@using AmuleRemoteControl.Components.Interfaces
@implements IDisposable

@if (AccessService!.IsAuthorized)
{
    @if (_downloadFiles == null)
    {
        <p>No data</p>
    }
    else
    {
        @foreach (var data in _downloadFiles.OrderBy(x => x.Status))
        {
            <RadzenCard Variant="Variant.Filled" Class="rz-p-2" Style="margin-bottom: 0.5rem;">
                <div @onclick="@(() => Expand(data.FileId))" style="cursor: pointer;">

                    <!-- Header: Filename & Status -->
                    <RadzenStack Orientation="Orientation.Vertical" Gap="0.2rem">
                        <RadzenText TextStyle="TextStyle.Subtitle1"
                                    Style="font-weight: bold; color: var(--rz-text-title-color); word-break: break-all;">@data.FileName</RadzenText>

                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center"
                                     JustifyContent="JustifyContent.SpaceBetween">
                            <RadzenBadge BadgeStyle="@GetStatusBadgeStyle(data.Status)" Text="@data.Status"
                                         Variant="Variant.Flat"/>
                            @if (data.Status != "Paused")
                            {
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center"
                                             Gap="0.2rem">
                                    <RadzenIcon Icon="speed" Style="font-size: 1rem; color: var(--rz-secondary);"/>
                                    <RadzenText TextStyle="TextStyle.Caption"
                                                Style="font-weight: bold;">@data.DownloadSpeed</RadzenText>
                                </RadzenStack>
                            }
                        </RadzenStack>
                    </RadzenStack>

                    <!-- Progress Bar -->
                    <RadzenProgressBar Value="@data.Progress" ShowValue="true" Style="height: 12px; margin: 0.5rem 0;"
                                       ProgressBarStyle="@(data.Status != "Paused" ? ProgressBarStyle.Success : ProgressBarStyle.Base)"/>

                    <!-- Footer Stats: Size & Completed -->
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center"
                                 JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenText TextStyle="TextStyle.Caption"><strong>Size:</strong> @data.Size</RadzenText>
                        <RadzenText TextStyle="TextStyle.Caption"><strong>Done:</strong> @data.Completed</RadzenText>
                        @* <RadzenText TextStyle="TextStyle.Caption"><strong>Src:</strong> @data.Sources</RadzenText> *@
                    </RadzenStack>

                    <!-- EXPANDED ACTION AREA -->
                    @if (_fileId == data.FileId)
                    {
                        <RadzenStack Gap="1rem" Class="rz-mt-3 rz-pt-3"
                                     Style="border-top: 1px solid var(--rz-border-color);">
                            <div @onclick:stopPropagation="true" style="cursor: default;">

                                <!-- Priority Stepper -->
                                <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">
                                    <RadzenText TextStyle="TextStyle.Overline" class="rz-color-secondary-text">
                                        PRIORITY
                                    </RadzenText>
                                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center"
                                                 JustifyContent="JustifyContent.SpaceBetween"
                                                 Style="border-radius: 8px; padding: 4px;">
                                        <RadzenButton Icon="remove" Click=@(() => PrioDown(data.FileId))
                                                      ButtonStyle="ButtonStyle.Base" Variant="Variant.Text"
                                                      Size="ButtonSize.Medium"/>
                                        <RadzenText TextStyle="TextStyle.Body2"
                                                    Style="font-weight: bold;">@data.Priority</RadzenText>
                                        <RadzenButton Icon="add" Click=@(() => PrioUp(data.FileId))
                                                      ButtonStyle="ButtonStyle.Base" Variant="Variant.Text"
                                                      Size="ButtonSize.Medium"/>
                                    </RadzenStack>
                                </RadzenStack>
                            </div>
                            <!-- Actions Row -->
                            <RadzenRow Gap="0.5rem">
                                <RadzenColumn Size="6">
                                    @if (data.Status == "Paused")
                                    {
                                        <RadzenButton Text="Resume" Icon="play_arrow" Click=@(() => Resume(data.FileId))
                                                      ButtonStyle="ButtonStyle.Primary" Variant="Variant.Flat"
                                                      Shade="Shade.Light" Size="ButtonSize.Medium"
                                                      Style="width: 100%;"/>
                                    }
                                    else
                                    {
                                        <RadzenButton Text="Pause" Icon="pause" Click=@(() => Pause(data.FileId))
                                                      ButtonStyle="ButtonStyle.Secondary" Variant="Variant.Flat"
                                                      Shade="Shade.Light" Size="ButtonSize.Medium"
                                                      Style="width: 100%;"/>
                                    }
                                </RadzenColumn>
                                <RadzenColumn Size="6">
                                    <RadzenButton Text="Delete" Icon="delete" Click=@(() => Cancel(data.FileId))
                                                  ButtonStyle="ButtonStyle.Dark" Variant="Variant.Flat"
                                                  Shade="Shade.Light" Size="ButtonSize.Medium" Style="width: 100%;"/>
                                </RadzenColumn>
                            </RadzenRow>

                        </RadzenStack>
                    }
                </div>
            </RadzenCard>
            <br/>
        }
    }
}

@code {
    [Inject] public IAmuleRemoteServices? Service { get; set; }
    [Inject] public IAccessService? AccessService { get; set; }

    IList<DownloadFile> _downloadFiles = new List<DownloadFile>();
    private CancellationTokenSource? _cts;

    string _fileId = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        if (AccessService is { IsAuthorized: true })
        {
            await Refresh();
            if (Service != null) await Service.AutoStatus();
        }
        else
        {
            NavManager.NavigateTo("/login");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _cts = new CancellationTokenSource();
            _ = AutoRefresh(_cts.Token);
        }
    }

    private async Task Refresh()
    {
        _downloadFiles = await Service!.GetDownloading();
        await Service.AutoDownSpeed();
        StateHasChanged();
    }

    private async Task Resume(string fileId)
    {
        _downloadFiles = await Service!.PostDownloadCommand(fileId, "resume");
        StateHasChanged();
    }

    private async Task Pause(string fileId)
    {
        _downloadFiles = await Service!.PostDownloadCommand(fileId, "pause");

        StateHasChanged();
    }

    private async Task Cancel(string fileId)
    {
        _downloadFiles = await Service!.PostDownloadCommand(fileId, "cancel");

        StateHasChanged();
    }

    private async Task PrioUp(string fileId)
    {
        _downloadFiles = await Service!.PostDownloadCommand(fileId, "prioup");

        StateHasChanged();
    }

    private async Task PrioDown(string fileId)
    {
        _downloadFiles = await Service!.PostDownloadCommand(fileId, "priodown");

        StateHasChanged();
    }

    private async Task AutoRefresh(CancellationToken cancellationToken)
    {
        try
        {
            while (!cancellationToken.IsCancellationRequested)
            {
                await Task.Delay(5000, cancellationToken);
                await Refresh();
            }
        }
        catch (OperationCanceledException)
        {
            // Expected when component is disposed or navigation occurs
        }
    }

    private void Expand(string fileId)
    {
        if (_fileId == fileId)
        {
            _fileId = string.Empty;
        }
        else
        {
            _fileId = fileId;
        }
    }

    private BadgeStyle GetStatusBadgeStyle(string status)
    {
        return status switch
        {
            "Downloading" => BadgeStyle.Success,
            "Waiting" => BadgeStyle.Warning,
            "Paused" => BadgeStyle.Light,
            "Completing" => BadgeStyle.Info,
            _ => BadgeStyle.Secondary
        };
    }

    public void Dispose()
    {
        _cts?.Cancel();
        _cts?.Dispose();
    }

}
