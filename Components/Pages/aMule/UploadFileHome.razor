@page "/upload"
@using AmuleRemoteControl.Components.Data.AmuleModel
@using AmuleRemoteControl.Components.Interfaces

@if (_accessService.IsAuthorized)
{
    @if (uploadFiles == null)
    {
        <p class="rz-p-4">Loading uploads...</p>
    }
    else
    {
        <!-- Main Fixed-Layout Container -->
        <div style="height: 100%; display: flex; flex-direction: column; overflow: hidden;">
            
            <!-- Fixed Header: Refresh Action -->
            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center" Class="rz-p-3" Style="flex: 0 0 auto; border-bottom: 1px solid var(--rz-base-300);">
                <RadzenText TextStyle="TextStyle.H6" Style="font-weight: 800; color: var(--rz-primary); margin: 0;">
                    Active Uploads
                </RadzenText>
                <RadzenButton ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Size="ButtonSize.Small" Icon="sync" Text="Refresh" Click="Refresh" />
            </RadzenStack>

            <!-- Scrollable Content -->
            <div style="flex: 1 1 auto; overflow-y: auto; padding: 1rem; min-height: 0;">
                
                @if (uploadFiles.Count == 0)
                {
                    <RadzenText TextStyle="TextStyle.Body1" Class="rz-color-secondary-text" Style="text-align: center; margin-top: 2rem;">
                        No active uploads.
                    </RadzenText>
                }
                
                @foreach (var file in uploadFiles)
                {
                    <RadzenCard Variant="Variant.Outlined" Class="rz-p-3 rz-mb-2" Style="border-radius: 12px;">
                        
                        <!-- File Name & User -->
                        <RadzenStack Orientation="Orientation.Vertical" Gap="0.2rem" Class="rz-mb-2">
                            <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H6" Style="font-weight: 700; color: var(--rz-text-title-color); word-break: break-all;">
                                @file.FileName
                            </RadzenText>
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.3rem">
                                <RadzenIcon Icon="person" Style="font-size: 0.9rem; color: var(--rz-secondary);" />
                                <RadzenText TextStyle="TextStyle.Caption" Class="rz-color-secondary-text">
                                    @file.UserName
                                </RadzenText>
                            </RadzenStack>
                        </RadzenStack>

                        <!-- Stats Row -->
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Style="border-top: 1px solid var(--rz-base-300); padding-top: 0.5rem;">
                            
                            <!-- Speed -->
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.2rem">
                                <RadzenIcon Icon="speed" Style="font-size: 1rem; color: var(--rz-success);" />
                                <RadzenText TextStyle="TextStyle.Caption" Style="font-weight: 600;">
                                    @file.Speed
                                </RadzenText>
                            </RadzenStack>

                            <!-- Data Transferred -->
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem">
                                <RadzenText TextStyle="TextStyle.Caption">
                                    <span style="color: var(--rz-secondary);">Up:</span> @file.Up
                                </RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption">
                                    <span style="color: var(--rz-secondary);">Down:</span> @file.Down
                                </RadzenText>
                            </RadzenStack>

                        </RadzenStack>

                    </RadzenCard>
                }
            </div>
        </div>
    }
}

@code {
    [Inject]
    public IAmuleRemoteServices _service { get; set; }
    [Inject]
    public IAccessService _accessService { get; set; }

    IList<UploadFile> uploadFiles = new List<UploadFile>();

    protected override async Task OnInitializedAsync()
    {
        if (_accessService.IsAuthorized)
        {
            await Refresh();
            await _service.AutoStatus();
        }
        else
        {
            NavManager.NavigateTo("/login");
        }
    }

    private async Task Refresh()
    {
        uploadFiles = await _service.GetUploads();
        StateHasChanged();
    }
}
