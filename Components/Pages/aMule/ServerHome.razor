@page "/server"
@using AmuleRemoteControl.Components.Data.AmuleModel
@using AmuleRemoteControl.Components.Interfaces
@using System.Text.RegularExpressions
@implements IDisposable

@if (_accessService.IsAuthorized)
{

    @if (servers == null)
    {
        <p>loading servers...</p>
    }
    else
    {
    <div style="height: 100%; display: flex; flex-direction: column; overflow: hidden;">
        <!-- Header Section (Fixed Height) -->
        <RadzenStack Gap="1rem" Class="rz-mb-2" Style="flex: 0 0 auto;">
            
            <!-- Connected Server Indicator -->
            @* <RadzenCard Variant="Variant.Filled" Class="rz-p-3" Style="border: 1px solid var(--rz-base-300);"> *@
                <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                        <RadzenIcon Icon="@(_service.Status.Ed2kStat.Contains("Connected") ? "check_circle" : "cancel")" 
                                    Style="@($"color: {(_service.Status.Ed2kStat.Contains("Connected") ? "var(--rz-success)" : "var(--rz-danger)")}; font-size: 1.5rem;")" />
                        <RadzenText TextStyle="TextStyle.Caption" Style="font-weight: bold; margin: 0;">
                            @(_service.Status.Ed2kStat.Contains("Connected") ? "ED2K Connected" : "ED2K Disconnected")
                        </RadzenText>
                    </RadzenStack>

                    @if (_service.Status.Ed2kStat.Contains("Connected"))
                    {
                        var serverInfo = ParseConnectedServerInfo(_service.Status.Ed2kStat);
                        <RadzenStack Orientation="Orientation.Vertical" Gap="0rem" Class="rz-pl-5">
                            <RadzenText TextStyle="TextStyle.Caption" Style="font-weight: 800; color: var(--rz-text-title-color);">@serverInfo.Name</RadzenText>
                            <RadzenText TextStyle="TextStyle.Caption" Class="rz-color-secondary-text" Style="font-family: monospace;">@serverInfo.Address</RadzenText>
                        </RadzenStack>
                    }
                    
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" Class="rz-mt-1">
                         <RadzenIcon Icon="@(_service.Status.KadStat.Contains("Connected") ? "check_circle" : "cancel")" 
                                     Style="@($"color: {(_service.Status.KadStat.Contains("Connected") ? "var(--rz-success)" : "var(--rz-danger)")}; font-size: 1rem;")" />
                         <RadzenText TextStyle="TextStyle.Caption" Style="font-weight: bold;">KAD: @_service.Status.KadStat</RadzenText>
                    </RadzenStack>
                </RadzenStack>
            @* </RadzenCard> *@

            <!-- Toolbar -->
            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                    <RadzenButton ButtonStyle="@(activeSortColumn == "Name" ? ButtonStyle.Primary : ButtonStyle.Light)" Variant="Variant.Flat" Size="ButtonSize.Small" Icon="sort_by_alpha" Click="OrderByName" Text="Name" />
                    <RadzenButton ButtonStyle="@(activeSortColumn == "Users" ? ButtonStyle.Primary : ButtonStyle.Light)" Variant="Variant.Flat" Size="ButtonSize.Small" Icon="group" Click="OrderByUsers" Text="Users" />
                    <RadzenButton ButtonStyle="@(activeSortColumn == "Files" ? ButtonStyle.Primary : ButtonStyle.Light)" Variant="Variant.Flat" Size="ButtonSize.Small" Icon="folder" Click="OrderByFiles" Text="Files" />
                </RadzenStack>
                @* <RadzenButton IsBusy=@busy ButtonStyle="ButtonStyle.Base" Size="ButtonSize.Small" Icon="refresh" Click="Refresh" /> *@
            </RadzenStack>

        </RadzenStack>

        <!-- Scrollable Server List (Flex Grow) -->
        <div style="flex: 1 1 auto; overflow-y: auto; padding-bottom: 10px; min-height: 0;">
            @foreach (var server in _servers)
            {
                <RadzenCard Variant="Variant.Outlined" Class="rz-p-3" Style="margin-bottom: 0.5rem; border-radius: 12px;">
                            
                    <!-- Card Header: Name & Connect Action -->
                    <RadzenRow AlignItems="AlignItems.Start" JustifyContent="JustifyContent.SpaceBetween" Class="rz-mb-2">
                        <RadzenColumn Size="8">
                            <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H6" Style="font-weight: 800; color: var(--rz-primary); margin-bottom: 0;">@server.ServerName</RadzenText>
                            <RadzenText TextStyle="TextStyle.Caption" Class="rz-color-secondary-text">@server.Address</RadzenText>
                        </RadzenColumn>
                        <RadzenColumn Size="4" Class="rz-text-align-right">
                                <RadzenButton ButtonStyle="ButtonStyle.Primary" Variant="Variant.Flat" Size="ButtonSize.Small" Icon="bolt" Text="Connect" Click=@(args => ConnectServer(server)) />
                        </RadzenColumn>
                    </RadzenRow>

                    <!-- Description -->
                    @if (!string.IsNullOrEmpty(server.Description))
                    {
                        <RadzenText TextStyle="TextStyle.Body2" Class="rz-mb-3 rz-color-base-content" Style="font-size: 0.85rem; line-height: 1.2;">
                            @server.Description
                        </RadzenText>
                    }

                    <!-- Footer: Stats & Delete -->
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Style="border-top: 1px solid var(--rz-base-300); padding-top: 0.5rem;">
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.2rem">
                                <RadzenIcon Icon="group" Style="font-size: 1rem; color: var(--rz-secondary);" />
                                <RadzenText TextStyle="TextStyle.Caption">@_utilityService.FormatAsGeneral(server.Users)</RadzenText>
                            </RadzenStack>
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.2rem">
                                <RadzenIcon Icon="folder" Style="font-size: 1rem; color: var(--rz-secondary);" />
                                <RadzenText TextStyle="TextStyle.Caption">@_utilityService.FormatAsGeneral(server.Files)</RadzenText>
                            </RadzenStack>
                        </RadzenStack>
                        
                        <RadzenButton ButtonStyle="ButtonStyle.Base" Variant="Variant.Text" Size="ButtonSize.Small" Icon="delete" Class="rz-p-0" Click=@(args => DeleteServer(server)) />
                    </RadzenStack>

                </RadzenCard>
            }
        </div>
    </div>

    }
}
@code {
    [Inject]
    public IAmuleRemoteServices _service { get; set; }
    [Inject]
    public IAccessService _accessService { get; set; }
    [Inject]
    public IUtilityServices _utilityService { get; set; }

    IList<Servers> servers;
    IEnumerable<Servers> _servers = new List<Servers>();

    // Stats stat = new Stats();
    bool busy;
    // RadzenDataGrid<Servers> grid; // Removed
    // int count; // Removed

    protected override async Task OnInitializedAsync()
    {
        _service.StatusChanged += this.OnStateChanged;

        if (_accessService.IsAuthorized)
        {
            servers = await _service.GetServers();
            _servers = servers; // Initialize view list
            // stat = await _service.GetStats();
            await _service.AutoStatus();
            StateHasChanged();

        }
        else
        {
            NavManager.NavigateTo("/login");
        }

    }

    private void OnStateChanged(object? sender, EventArgs e)
       => this.InvokeAsync(StateHasChanged);

    public void Dispose()
        => _service.StatusChanged -= this.OnStateChanged;

    protected async Task ConnectServer(Servers server)
    {
        servers = await _service.ConnectServer(server.ServerId, server.Port);
        _servers = servers; // Update view
        // stat = await _service.GetStats();
        StateHasChanged();
        if (servers != null)
        {
            NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Info,
                        Summary = "Server Connected",
                        Detail = $"Server {server.ServerName} connected",
                        Duration = 4000

                    });
        }
        else
        {
            NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Error,
                        Summary = "Fail server connection",
                        Detail = $"Error in connection server: check the log.",
                        Duration = 4000

                    });
        }
    }

    protected async Task DeleteServer(Servers server)
    {
        //confirm delete
        var dialogResult = await DialogService.OpenAsync("Confirm Delete", ds =>
    @<RadzenStack Gap="1.5rem">
        <p>Do you want delete the server <b>@server.ServerName</b>?</p>
        <RadzenStack Gap="2rem" Class="rz-p-4 rz-p-md-12">
            <RadzenRow AlignItems="AlignItems.Center" Class="rz-mt-4">
                <RadzenButton Text="No" Click="() => ds.Close(false)" ButtonStyle="ButtonStyle.Light" />
                <RadzenButton Click="() => ds.Close(true)" Text="Yes" ButtonStyle="ButtonStyle.Secondary"></RadzenButton>
            </RadzenRow>
        </RadzenStack>
    </RadzenStack>
    );

        if (dialogResult != null && dialogResult)
        {

            servers = await _service.RemoveServer(server.ServerId, server.Port);
            _servers = servers; // Update view
            // stat = await _service.GetStats();
            StateHasChanged();

            if (servers != null)
            {
                NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Info,
                        Summary = "Server Removed",
                        Detail = $"Server {server.ServerName} removed",
                        Duration = 4000

                    });
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Error,
                        Summary = "Fail server remove",
                        Detail = $"Error in delete server: check the log.",
                        Duration = 4000

                    });
            }
        }
    }

    // LoadData removed

    protected async Task Refresh()
    {
        busy = true;
        // stat = await _service.GetStats();
        busy = false;
        StateHasChanged();
    }

    bool orderNameAsc = false;
    bool orderUsersAsc = false;
    bool orderFilesAsc = false;
    string activeSortColumn = "";

    protected void OrderByName()
    {
        activeSortColumn = "Name";
        if (orderNameAsc)
        {
            _servers = servers.OrderBy(x => x.ServerName).ToList();
        }
        else
        {
            _servers = servers.OrderByDescending(x => x.ServerName).ToList();
        }

        orderNameAsc = !orderNameAsc;
        StateHasChanged();
    }

    protected void OrderByUsers()
    {
        activeSortColumn = "Users";
        if (orderUsersAsc)
        {
            _servers = servers.OrderBy(x => Convert.ToInt32(x.Users)).ToList();
        }
        else
        {
            _servers = servers.OrderByDescending(x => Convert.ToInt32(x.Users)).ToList();
        }

        orderUsersAsc = !orderUsersAsc;
        StateHasChanged();
    }

    protected void OrderByFiles()
    {
        activeSortColumn = "Files";
        if (orderFilesAsc)
        {
            _servers = servers.OrderBy(x => Convert.ToInt32(x.Files)).ToList();
        }
        else
        {
            _servers = servers.OrderByDescending(x => Convert.ToInt32(x.Files)).ToList();
        }

        orderFilesAsc = !orderFilesAsc;
        StateHasChanged();
    }

    private (string Name, string Address) ParseConnectedServerInfo(string status)
    {
        if (string.IsNullOrEmpty(status)) return ("Unknown", "");

        // Expected format: "Connected to ServerName (IP:Port)"
        // Or "Connected to: ServerName (IP:Port)"
        // Or just "Connected"
        try
        {
            var match = Regex.Match(status, @"Connected to:?\s*(.+?)\s*\((.+?)\)", RegexOptions.IgnoreCase);
            if (match.Success)
            {
                return (match.Groups[1].Value.Trim(), match.Groups[2].Value.Trim());
            }
        }
        catch 
        {
            // Ignore parse errors
        }

        return (status, "");
    }
}


