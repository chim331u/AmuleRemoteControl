@page "/search"
@using AmuleRemoteControl.Components.Data.AmuleModel
@using AmuleRemoteControl.Components.Interfaces
@implements IDisposable

@if (_accessService.IsAuthorized)
{
    <!-- Main Fixed-Layout Container -->
    <div style="height: 100%; display: flex; flex-direction: column; overflow: hidden;">

        <!-- FIXED HEADER: Search Bar -->
        <RadzenStack Gap="1rem" Class="rz-p-3" Style="flex: 0 0 auto; border-bottom: 1px solid var(--rz-base-300);">
            
            <RadzenText TextStyle="TextStyle.H6" Style="font-weight: 800; color: var(--rz-primary); margin: 0;">
                Search Files
            </RadzenText>

            <!-- Search Inputs Row -->
            <RadzenRow AlignItems="AlignItems.Center" Gap="0.5rem">
                <RadzenColumn Size="12" SizeMD="8">
                    <RadzenTextBox @bind-Value="@searchText" Placeholder="Enter filename..." Style="width: 100%;" 
                                 @onkeypress="@(args => { if (args.Key == "Enter") Search(); })" />
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="4">
                    <RadzenDropDown Data="@(Enum.GetValues(typeof(SearchType)).Cast<Enum>())" 
                                  @bind-Value="@_searchType" Style="width: 100%;" />
                </RadzenColumn>
            </RadzenRow>

            <!-- Actions Row -->
            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                <RadzenButton ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Size="ButtonSize.Small" 
                             Icon="sync" Text="Refresh" Click="RefreshSearchResult" />
                
                <RadzenButton Icon="search" Text="Search" Click="Search" IsBusy="@searchIsBusy" 
                             ButtonStyle="ButtonStyle.Primary" Variant="Variant.Flat" Size="ButtonSize.Small" />
            </RadzenStack>

        </RadzenStack>

        <!-- SCROLLABLE CONTENT: Results List -->
        <div style="flex: 1 1 auto; overflow-y: auto; padding: 1rem; min-height: 0;">
            
            @if (searchResult.Count == 0 && !searchIsBusy)
            {
                <RadzenText TextStyle="TextStyle.Body1" Class="rz-color-secondary-text" Style="text-align: center; margin-top: 2rem;">
                    Wait for results...
                </RadzenText>
            }

            @foreach (var file in searchResult)
            {
                <RadzenCard Variant="Variant.Outlined" Class="rz-p-3 rz-mb-2" Style="border-radius: 12px;">
                    <RadzenRow AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                        
                        <!-- File Info -->
                        <RadzenColumn Size="9">
                            <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H6" 
                                      Style="font-weight: 700; color: var(--rz-text-title-color); word-break: break-all; margin-bottom: 0.2rem;">
                                @file.FileName
                            </RadzenText>
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem">
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.2rem">
                                    <RadzenIcon Icon="data_usage" Style="font-size: 0.9rem; color: var(--rz-secondary);" />
                                    <RadzenText TextStyle="TextStyle.Caption">@file.FileSize</RadzenText>
                                </RadzenStack>
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.2rem">
                                    <RadzenIcon Icon="group" Style="font-size: 0.9rem; color: var(--rz-secondary);" />
                                    <RadzenText TextStyle="TextStyle.Caption">@file.Sources Sources</RadzenText>
                                </RadzenStack>
                            </RadzenStack>
                        </RadzenColumn>

                        <!-- Download Action -->
                        <RadzenColumn Size="3" Class="rz-text-align-right">
                             <RadzenButton Icon="download" ButtonStyle="ButtonStyle.Secondary" Variant="Variant.Flat" 
                                          Size="ButtonSize.Small" Click="@(() => DownloadFile(file))" />
                        </RadzenColumn>

                    </RadzenRow>
                </RadzenCard>
            }
        </div>
    </div>
}

@code {
    [Inject]
    public IAmuleRemoteServices _service { get; set; }
    [Inject]
    public IAccessService _accessService { get; set; }

    string searchText = string.Empty;
    List<Search> searchResult = new List<Search>();
    bool searchIsBusy = false;
    private CancellationTokenSource? _cts;
    SearchType? _searchType = SearchType.Global;

    protected override async Task OnInitializedAsync()
    {
        if (!_accessService.IsAuthorized)
        {
            NavManager.NavigateTo("/login");
        }
        else
        {
            await _service.AutoStatus();
        }
    }

    protected async Task Search()
    {
        if (!string.IsNullOrEmpty(searchText))
        {
            searchIsBusy = true;
            searchResult = new List<Search>();
            searchResult = await _service.SearchFiles(searchText.Replace(" ", "+"), _searchType.GetDisplayDescription(), "all");
            searchIsBusy = false;
            StateHasChanged();

            if (searchResult != null)
            {
                // Cancel existing auto-refresh if any
                _cts?.Cancel();
                _cts?.Dispose();

                // Start new auto-refresh
                _cts = new CancellationTokenSource();
                _ = AutoRefresh(_cts.Token);

                NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Info,
                        Summary = "Search in progress",
                        Detail = $"Searching ... Auto Refresh activated",
                        Duration = 4000

                    });

            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Error,
                        Summary = "Fail search file",
                        Detail = $"Error in searching: check the log.",
                        Duration = 4000

                    });
            }
        }
    }

    protected async Task RefreshSearchResult()
    {
        searchResult = await _service.RefreshSearch();
        StateHasChanged();
    }

    protected async Task DownloadFile(Search file)
    {
        var result = await _service.DownloadSearch(file.SearchId);

        // NavManager.NavigateTo("downloading");

        if (!string.IsNullOrEmpty(result))
        {
            NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Download file",
                    Detail = $"File {file.FileName} in download",
                    Duration = 4000

                });
        }
        else
        {
            NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Fail download file",
                    Detail = $"Error in downloading file: check the log.",
                    Duration = 4000

                });
        }
    }

    protected async Task AutoRefresh(CancellationToken cancellationToken)
    {
        try
        {
            while (!cancellationToken.IsCancellationRequested)
            {
                await Task.Delay(5000, cancellationToken);

                await RefreshSearchResult();
                // searchResult = await _service.SearchFiles(searchText.Replace(" ", "+"), _searchType.GetDisplayDescription(), "all");
                StateHasChanged();
            }
        }
        catch (OperationCanceledException)
        {
            // Expected when component is disposed or new search is initiated
        }
    }

    public void Dispose()
    {
        _cts?.Cancel();
        _cts?.Dispose();
    }
}
