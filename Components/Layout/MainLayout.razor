@inherits LayoutComponentBase
@implements IDisposable

<RadzenLayout>
    <RadzenHeader>
        <RadzenRow AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Gap="2px"
                   Style="padding-left: 1rem; padding-right: 0.5rem;">

            @if (_service.Status != null && _service.Status.Ed2kStat != null)
            {
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center"
                             JustifyContent="JustifyContent.Center">
                    <RadzenIcon Icon="@(_service.Status.Ed2kStat.Contains("Connected") ? "link" : "link_off")"
                                Style="@($"font-size: 1.8rem; color: {(_service.Status.Ed2kStat.Contains("Connected") ? "var(--rz-success)" : "var(--rz-danger)")}")"/>
                    <RadzenStack><strong>ED2K</strong></RadzenStack>
                </RadzenStack>
            }
            @if (_service.Status != null && _service.Status.KadStat != null)
            {
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center"
                             JustifyContent="JustifyContent.Center">
                    <RadzenIcon Icon="@(_service.Status.KadStat.Contains("Connected") ? "link" : "link_off")"
                                Style="@($"font-size: 1.8rem; color: {(_service.Status.KadStat.Contains("Connected") ? "var(--rz-success)" : "var(--rz-danger)")}")"/>
                    <RadzenStack><strong>KAD</strong></RadzenStack>
                </RadzenStack>
            }

            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center"
                         JustifyContent="JustifyContent.Center">
                <RadzenIcon Icon="speed" Style="font-size: 1.8rem;"/>
                <RadzenStack Style="color: white"><strong>@_service.DownSpeed</strong></RadzenStack>
            </RadzenStack>

            <RadzenProfileMenu Click="@OnProfileClick">
                <Template>
                    @if (_accessService.IsAuthorized)
                    {
                        <RadzenImage Path="Images\amule-logo-green.png" style="width: 32px"></RadzenImage>
                    }
                    else
                    {
                        <RadzenGravatar Email="user@example.com"></RadzenGravatar>
                    }
                </Template>
                <ChildContent>
                    @if (_accessService.IsAuthorized)
                    {
                        <RadzenProfileMenuItem Text="Setting mule" Path="preference"
                                               Icon="settings"></RadzenProfileMenuItem>
                        <RadzenProfileMenuItem Text="Log mule" Path="logamule" Icon="article"></RadzenProfileMenuItem>
                        <hr/>
                        <RadzenProfileMenuItem Text="Logout" Icon="logout"></RadzenProfileMenuItem>
                    }
                    else
                    {
                        <RadzenProfileMenuItem Text="Login" Path="login" Icon="account_box"></RadzenProfileMenuItem>
                        <RadzenProfileMenuItem Text="About" Path="about" Icon="question_mark"></RadzenProfileMenuItem>
                    }
                    <hr/>
                    <RadzenProfileMenuItem Text="Setting App" Icon="app_settings_alt"
                                           Path="setting"></RadzenProfileMenuItem>
                    <RadzenProfileMenuItem Text="Log App" Icon="article" Path="logger"></RadzenProfileMenuItem>
                    <RadzenStack Gap="1px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.End">
                        <hr/>
                        <p> v 2.1.0</p>
                        </RadzenStack>
                </ChildContent>
            </RadzenProfileMenu>

            @* </RadzenStack> *@
        </RadzenRow>
    </RadzenHeader>

    <RadzenBody Style="overflow: hidden">

        <div style="height: 100%; width: 100%; overflow-x: hidden; overflow-y: auto;">
            @Body
        </div>
    </RadzenBody>
    <RadzenFooter>
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0"
                     JustifyContent="JustifyContent.SpaceEvenly" Wrap="FlexWrap.NoWrap"
                     Style="width: 100%; padding: 0.5rem 0;">

            <RadzenStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Center"
                         JustifyContent="JustifyContent.Center" Gap="0.2rem"
                         onclick="@(() => NavigateTo("upload"))" Style="cursor: pointer; min-width: 60px;">
                <RadzenIcon Icon="file_upload" Style="font-size: 2.5rem;"/>
                <RadzenText TextStyle="TextStyle.Caption" Style="font-weight: bold;">Upload</RadzenText>
            </RadzenStack>

            <RadzenStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Center"
                         JustifyContent="JustifyContent.Center" Gap="0.2rem"
                         onclick="@(() => NavigateTo("server"))" Style="cursor: pointer; min-width: 60px;">
                <RadzenIcon Icon="dns" Style="font-size: 2.5rem;"/>
                <RadzenText TextStyle="TextStyle.Caption" Style="font-weight: bold;">Server</RadzenText>
            </RadzenStack>

            <RadzenStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Center"
                         JustifyContent="JustifyContent.Center" Gap="0.2rem"
                         onclick="@(() => NavigateTo("addlink"))" Style="cursor: pointer; min-width: 60px;">
                <RadzenIcon Icon="add_link" Style="font-size: 2.5rem;"/>
                <RadzenText TextStyle="TextStyle.Caption" Style="font-weight: bold;">Add Link</RadzenText>
            </RadzenStack>

            <RadzenStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Center"
                         JustifyContent="JustifyContent.Center" Gap="0.2rem"
                         onclick="@(() => NavigateTo("search"))" Style="cursor: pointer; min-width: 60px;">
                <RadzenIcon Icon="search" Style="font-size: 2.5rem;"/>
                <RadzenText TextStyle="TextStyle.Caption" Style="font-weight: bold;">Search</RadzenText>
            </RadzenStack>

            <RadzenStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Center"
                         JustifyContent="JustifyContent.Center" Gap="0.2rem"
                         onclick="@(() => NavigateTo("home"))" Style="cursor: pointer; min-width: 60px;">
                <RadzenIcon Icon="file_download" Style="font-size: 2.5rem;"/>
                <RadzenText TextStyle="TextStyle.Caption" Style="font-weight: bold;">Download</RadzenText>
            </RadzenStack>

        </RadzenStack>
    </RadzenFooter>
</RadzenLayout>


@code {

    [Inject] public IAccessService _accessService { get; set; }
    [Inject] public IAmuleRemoteServices _service { get; set; }

    [Inject] public ICultureProvider _cultureProvider { get; set; }

    [Inject] public IUtilityServices UtilityServices { get; set; }

    [Inject] public IDeepLinkService DeepLinkService { get; set; }

    // Stats? stat = new Stats();
    protected override void OnInitialized()
    {
        _accessService.OnChange += this.OnAuthChanged;
        _service.StatusChanged += this.OnStateChanged;
        _service.DownChanged += this.OnDownChanged;

        DeepLinkService.LinkReceived += OnLinkReceived;

        // Culture is now managed by ICultureProvider and applied automatically
        // No need to set it here as CultureProvider sets it in its constructor
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            if (!UtilityServices.IsOnboardingCompleted())
            {
                // Add a small delay to ensure UI is ready
                await Task.Delay(500);
                await DialogService.OpenAsync<OnboardingDialog>("Welcome", null, new DialogOptions() { Width = "90%", Height = "auto", CloseDialogOnOverlayClick = false });
            }

            // Check for pending deep link (cold start) logic here or in OnInitialized
            // Putting it in OnAfterRender ensures the Router is fully ready
            var pendingLink = DeepLinkService.GetPendingLink();
            if (pendingLink != null)
            {
                await Task.Delay(300); // Small delay to let initial page load slightly
                ProcessLink(pendingLink.Url);
            }
        }
    }

    private void OnStateChanged(object? sender, EventArgs e)
        => this.InvokeAsync(StateHasChanged);

    private void OnDownChanged(object? sender, EventArgs e)
        => this.InvokeAsync(StateHasChanged);

    private void OnAuthChanged(object? sender, EventArgs e)
        => this.InvokeAsync(StateHasChanged);

    public void Dispose()
    {
        _accessService.OnChange -= OnAuthChanged;
        _service.StatusChanged -= OnStateChanged;
        _service.DownChanged -= OnDownChanged;
        if (DeepLinkService != null)
        {
            DeepLinkService.LinkReceived -= OnLinkReceived;
        }
    }

    private void OnLinkReceived(object? sender, DeepLinkEventArgs e)
    {
        InvokeAsync(() => ProcessLink(e.Url));
    }

    private void ProcessLink(string url)
    {
        // Add a small delay/check to ensure we are ready to navigate
        // If the user is on a modal (like Onboarding), this might be tricky, 
        // but NavManager usually handles replacing the view.
        // We navigate to AddLink which handles auth redirect if needed.
        NavManager.NavigateTo($"/addlink?url={Uri.EscapeDataString(url)}");
    }

    private void UpdateStatus()
    {
        var test = _service.Status;
        _service.AutoStatus();
    }

    private void NavigateTo(string page)
    {
        NavManager.NavigateTo($"/{page}");
    }

    private void OnProfileClick(RadzenProfileMenuItem menuItem)
    {
        if (menuItem.Text == "Logout")
        {
            _accessService.LoggedOut();
            _accessService.IsAuthorized = false;

            NavManager.NavigateTo("/login/true");
            StateHasChanged();
        }
    }

}

<RadzenDialog/>
<RadzenNotification/>
<RadzenContextMenu/>
<RadzenTooltip/>
